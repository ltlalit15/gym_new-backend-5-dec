generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url       = env("DATABASE_URL")
}

model Alert {
  id        Int      @id @default(autoincrement())
  type      String
  message   String
  memberId  Int?
  staffId   Int?
  branchId  Int
  createdAt DateTime @default(now())

  branch Branch @relation(fields: [branchId], references: [id]) // FIX: branch -> Branch
  member Member?  @relation(fields: [memberId], references: [id])
  user   User?  @relation(fields: [staffId], references: [id])

  @@index([branchId])
  @@index([memberId])
  @@index([staffId])
}

model Booking {
  id            Int           @id @default(autoincrement())
  memberId      Int
  scheduleId    Int
  
  member        Member        @relation(fields: [memberId], references: [id])
  classschedule ClassSchedule @relation(fields: [scheduleId], references: [id])

  @@index([memberId])
  @@index([scheduleId])
}

model Branch {
  id               Int                @id @default(autoincrement())
  name             String
  phone            String?
  createdAt        DateTime           @default(now())
  address          String?
  status           branch_status      @default(ACTIVE)
  adminId          Int
  alert            Alert[]
  classschedule    ClassSchedule[]
  expense          Expense[]
  member           Member[]
  memberattendance MemberAttendance[]
  plan             Plan[]
  product          Product[]
  session          Session[]
  staffattendance  StaffAttendance[]
  user             User[]
  admin             User  @relation("AdminToStaff", fields: [adminId], references: [id])
}

model Member {
  id                Int       @id @default(autoincrement())
  fullName          String
  email             String?   @unique
  password          String?
  phone             String
  gender            String?
  dateOfBirth       DateTime?
  interestedIn      String?
  address           String?
  joinDate          DateTime  @default(now())
  branchId          Int
  planId            Int?
  membershipFrom    DateTime?
  membershipTo      DateTime?
  paymentMode       String?
  amountPaid        Float?     // can store decimals
  status            String   @default("ACTIVE")


  branch Branch @relation(fields: [branchId], references: [id])
  plan   Plan?  @relation(fields: [planId], references: [id])

  attendances MemberAttendance[]
  bookings     Booking[]
  payments     Payment[]
  alerts       Alert[]
  dietPlanAssignments      DietPlanAssignment[]   // new
  workoutPlanAssignments   WorkoutPlanAssignment[]  // new
  notificationLog          NotificationLog[]
}


model Plan {
  id             Int           @id @default(autoincrement())
  name           String
  duration       plan_duration
  price          Float
  createdAt      DateTime      @default(now())
  
  category       String?
  description    String?
  status         String        @default("ACTIVE")
  branchId       Int?
  sessions       Int           @default(0)
  validityDays   Int           @default(0)
  
  members        Member[]
  payments       Payment[]
  branch         Branch?       @relation(fields: [branchId], references: [id])

  @@index([branchId])
}

model MemberAttendance {
  id        Int      @id @default(autoincrement())
  memberId  Int
  branchId  Int
  checkIn   DateTime @default(now())
  checkOut  DateTime?
  createdAt DateTime @default(now())

  member    Member   @relation(fields: [memberId], references: [id])
  branch    Branch   @relation(fields: [branchId], references: [id]) // FIX: branch -> Branch

  @@index([branchId])
  @@index([memberId])
}

model StaffAttendance {
  id       Int       @id @default(autoincrement())
  staffId  Int
  branchId Int
  checkIn  DateTime  @default(now())
  checkOut DateTime?

  staff    User   @relation(fields: [staffId], references: [id])
  branch   Branch @relation(fields: [branchId], references: [id]) // FIX: branch -> Branch
  
  @@index([branchId])
  @@index([staffId])
}

model ClassType {
  id        Int             @id @default(autoincrement())
  name      String
  createdAt DateTime        @default(now())
  schedules ClassSchedule[]
}

model ClassSchedule {
  id            Int       @id @default(autoincrement())
  branchId      Int
  classTypeId   Int
  trainerId     Int
  date          DateTime
  startTime     String
  endTime       String
  capacity      Int
  
  members       Json?
  status        String    @default("Active")
  day           String?
  
  bookings      Booking[]

  branch        Branch    @relation(fields: [branchId], references: [id]) // FIX: branch -> Branch
  classType     ClassType @relation(fields: [classTypeId], references: [id])
  trainer       User      @relation(fields: [trainerId], references: [id])

  @@index([branchId])
  @@index([classTypeId])
  @@index([trainerId])
}

model DietMeal {
  id         Int      @id @default(autoincrement())
  dietPlanId Int
  time       String
  food       String
  
  dietplan   DietPlan @relation(fields: [dietPlanId], references: [id])
  
  @@index([dietPlanId])
}

model DietPlan {
  id                 Int                  @id @default(autoincrement())
  title              String
  notes              String?
  createdBy          Int
  branchId           Int
  createdAt          DateTime             @default(now())
  
  dietmeal           DietMeal[]
  dietplanassignment DietPlanAssignment[]
}

model DietPlanAssignment {
  id         Int      @id @default(autoincrement())
  dietPlanId Int
  memberId   Int
  assignedAt DateTime @default(now())
  
  dietplan   DietPlan @relation(fields: [dietPlanId], references: [id])
  member     Member   @relation(fields: [memberId], references: [id])

  @@index([dietPlanId])
  @@index([memberId])
}

model Expense {
  id        Int      @id @default(autoincrement())
  title     String
  category  String
  amount    Float
  date      DateTime @default(now())
  branchId  Int
  notes     String?
  createdAt DateTime @default(now())
  
  branch    Branch   @relation(fields: [branchId], references: [id]) // FIX: branch -> Branch

  @@index([branchId])
}

model NotificationLog {
  id        Int      @id @default(autoincrement())
  type      String
  to        String
  message   String
  status    String   @default("PENDING")
  createdAt DateTime @default(now())
  memberId  Int?
  
  member    Member?  @relation(fields: [memberId], references: [id])

  @@index([memberId])
}

model Payment {
  id          Int      @id @default(autoincrement())
  memberId    Int
  planId      Int
  amount      Float
  paymentDate DateTime @default(now())
  invoiceNo   String   @unique
  gstAmount   Float?
  gstPercent  Float?
  
  member      Member   @relation(fields: [memberId], references: [id])
  plan        Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([planId])
}

model Product {
  id            Int             @id @default(autoincrement())
  name          String
  sku           String?         @unique
  category      String?
  sellingPrice  Float
  costPrice     Float?
  currentStock  Int             @default(0)
  branchId      Int
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  
  branch        Branch          @relation(fields: [branchId], references: [id]) // FIX: branch -> Branch
  stockmovement StockMovement[]

  @@index([branchId])
}

model Purchase {
  id              Int      @id @default(autoincrement())
  selectedPlan    String
  companyName     String
  email           String
  billingDuration String
  startDate       DateTime
  purchaseDate    DateTime @default(now())
  status          String   @default("pending")
}

model Role {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now())
  
  user      User[]
}

model StockMovement {
  id        Int      @id @default(autoincrement())
  productId Int
  type      String
  quantity  Int
  note      String?
  createdAt DateTime @default(now())
  
  product   Product  @relation(fields: [productId], references: [id])

  @@index([productId])
}

model User {
  id                Int                 @id @default(autoincrement())
  fullName          String
  email             String              @unique
  password          String
  phone             String?
  roleId            Int
  branchId          Int?
  createdAt         DateTime            @default(now())
  address           String?
  description       String?
  duration          String?
  gymName           String?
  planName          String?
  price             String?
  status            String?
  
  alert             Alert[]
  classschedule     ClassSchedule[]
  staffattendance   StaffAttendance[]
  memberPlans       MemberPlan[]        @relation("UserMemberPlans")
  session           Session[]
  
  branch            Branch?             @relation(fields: [branchId], references: [id]) // FIX: branch -> Branch
  role              Role                @relation(fields: [roleId], references: [id])
  staff             Staff?              @relation("UserStaff")
    adminOfBranch   Branch[] @relation("AdminToStaff")


  


  @@index([branchId])
  @@index([roleId])
}





model Staff {
  id            Int      @id @default(autoincrement())
  userId        Int      @unique
  gender        String
  dateOfBirth   DateTime
  joinDate      DateTime
  exitDate      DateTime?
  profilePhoto  String?
  status        String   @default("Active")
  
  user          User     @relation("UserStaff", fields: [userId], references: [id])
}


model WorkoutExercise {
  id            Int         @id @default(autoincrement())
  workoutPlanId Int
  name          String
  sets          Int?
  reps          Int?
  duration      String?
  
  workoutplan   WorkoutPlan @relation(fields: [workoutPlanId], references: [id])

  @@index([workoutPlanId])
}

model WorkoutPlan {
  id                    Int                       @id @default(autoincrement())
  title                 String
  notes                 String?
  createdBy             Int
  branchId              Int
  createdAt             DateTime                  @default(now())
  
  workoutexercise       WorkoutExercise[]
  workoutplanassignment WorkoutPlanAssignment[]
}

model WorkoutPlanAssignment {
  id            Int           @id @default(autoincrement())
  workoutPlanId Int
  memberId      Int
  assignedAt    DateTime      @default(now())
  
  member        Member        @relation(fields: [memberId], references: [id])
  workoutplan   WorkoutPlan   @relation(fields: [workoutPlanId], references: [id])

  @@index([memberId])
  @@index([workoutPlanId])
}

enum plan_duration {
  Monthly
  Yearly
}

model MemberPlan {
  id           Int      @id @default(autoincrement())
  name         String
  sessions     Int
  validityDays Int
  price        Float
  type         String   @default("GROUP")
  
  adminId      Int
  admin        User     @relation("UserMemberPlans", fields: [adminId], references: [id])

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Session {
  id          Int      @id @default(autoincrement())
  sessionName String
  trainerId   Int
  branchId    Int
  date        DateTime
  time        String
  duration    Int
  description String?
  status      String   @default("Upcoming")

  trainer     User     @relation(fields: [trainerId], references: [id])
  branch      Branch   @relation(fields: [branchId], references: [id]) // FIX: branch -> Branch

  createdAt   DateTime @default(now())

  @@index([trainerId])
  @@index([branchId])
}

enum branch_status {
  ACTIVE
  INACTIVE
} 